---
title: "Rank History"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DBI)
library(dplyr)
library(ggplot2)
library(tidyr)
```


## Connect to Database

```{r}
con <- RSQLite::dbConnect(RSQLite::SQLite(), file.path("..", "hacker-news-dataset.sqlite"))
```

```{r}

tbl(con, "dataset") %>% 
  inner_join(tbl(con, "fullstories"), by = "id") %>% 
  group_by(id) %>% 
  summarize(maxScore = max(score)) %>% 
  ungroup() %>% 
  # filter(maxScore %in% c(10, 20, 50, 100, 200, 500)) 
  filter((maxScore > 950) & (maxScore < 1050)) %>% 
  head(3)
  
```

maxScore : id
 10      : 26558575
 20      : 26592685
 50      : 26603662
100      : 26620943
200      : 26624220
500      : 26612894
1000     : 26580614

```{r}

id_list <- c(
  26558575,
  26592685,
  26603662,
  26620943,
  26624220,
  26612894,
  26580614
)

maxScoreLvl <- seq(1, 7)

df <- data.frame(id = id_list, lvl = maxScoreLvl)

tbl(con, "dataset") %>% 
  filter(id %in% id_list) %>% 
  filter(!is.na(topRank) & (topRank <= 30)) %>% 
  mutate(age = sampleTime - submissionTime) %>% 
  select(id, age, topRank) %>% 
  as_tibble() %>% 
  inner_join(df, by = "id") %>% 
  mutate(age = age / 3600) %>% 
  ggplot(aes(x = age, y = topRank, color = factor(lvl), group = id)) +
  geom_point(size = 0.01) +
  geom_path() +
  scale_y_continuous(trans = "reverse")

```

```{r}
tbl(con, "dataset") %>% 
  inner_join(tbl(con, "fullstories"), by = "id") %>% 
  select(id) %>% 
  distinct() %>% 
  as_tibble() -> random_fullstory_ids

random_fullstory_ids <- random_fullstory_ids$id
```


```{r}
random_id <- sample(random_fullstory_ids, 1)

tbl(con, "dataset") %>% 
  filter(id == random_id) %>% 
  mutate(age = sampleTime - submissionTime) %>% 
  select(id, topRank, newRank, age) %>% 
  filter(age < 36000) %>%
  
  # pivot_longer(cols = c(topRank, newRank), names_to = "rankType", values_to = "value") %>% 
  # ggplot(aes(x = age, y = value, color = rankType)) +
  
  ggplot(aes(x = age, y = topRank)) +
  geom_point(size = 0.1) +
  scale_y_continuous(trans = "reverse")




```

# What is the Life Cycle of a Story?

it's posted -> 1 upvote (submitter's vote) a score is computed (0 in the beginning because submitter's vote doesn't count)
it moves through the *new* page -> the new page is FIFO (a queue)
  most people only look at first page of *new* -> limited window of opportunity for a story to pick up upvotes
if the story picks up a sufficient number of votes, it moves up on the frontpage -> goes to positive feedback loop
it lingers on the frontpage for some time, then the age penalty kicks in
  the story decays and moves down the frontpage until it's past its life cycle


```{r}

random_id <- sample(random_fullstory_ids, 5)


tbl(con, "dataset") %>% 
  filter(id %in% random_id) %>% 
  mutate(age = sampleTime - submissionTime) %>% 
  select(id, newRank, gain, score, age) %>%
  group_by(id) %>% 
  mutate(maxScore = max(score)) %>% 
  ungroup() %>% 
  as_tibble() -> random_story

max_score <- max(random_story$score, na.rm = TRUE)

random_story %>% 
  filter(newRank <= 30) %>% 
  ggplot(aes(x = age, y = newRank)) +
  geom_point(aes(size = gain, color = log10(maxScore))) +
  scale_y_continuous(trans = "reverse") +
  scale_color_viridis_c() +
  scale_size_continuous(breaks = c(0, 1, 2, 3)) +
  facet_wrap(. ~ id)


```






# Disconnect from Database

Don't forget to disconnect after session:

```{r}
RSQLite::dbDisconnect(conn = con)
```



