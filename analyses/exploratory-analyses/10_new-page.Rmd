---
title: "New Page"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

library(DBI)
library(dplyr)
library(tidyr)
library(ggplot2)
library(magrittr)

con <- RSQLite::dbConnect(RSQLite::SQLite(), file.path("..", "hacker-news-dataset.sqlite"))

Sys.setlocale("LC_TIME", "C")

```


## Score over Time

```{r score-over-time-data}
tbl(con, "dataset") %>% 
  select(id, submissionTime, score, sampleTime, samplingWindow, newRank) %>% 
  filter(samplingWindow > 1) %>% 
  select(-samplingWindow) %>% 
  data.frame() %>% 
  inner_join(
    tbl(con, "fullstories") %>% data.frame() %>% sample_n(500),
    by = "id"
  ) %>% 
  mutate(
    age = sampleTime - submissionTime,
    onNewPage = !(is.na(newRank)) & (newRank <= 90)
  ) -> tmp

```

```{r score-over-time-plot}
tmp %>% 
  ggplot(aes(x = score, y = age / 60 / 60, group = id, color = onNewPage)) +
  geom_line(alpha = 0.6, size = 0.2) +
  scale_x_log10() +
  scale_y_continuous(trans = "reverse") +
  scale_color_manual(values = c("FALSE" = "darkblue", "TRUE" = "gold")) +
  ylim(c(50, 0)) +
  labs(
    title = "Development of Score over Time",
    x = "Votes",
    y = "Age [hours]",
    color = "On New Page"
  ) +
  theme_classic()
```




## Stories Passing Through the `New` Page

The `new` page always ranks stories by their submission time in descending order, meaning the newest stories are displayed at the top. This, with a constant stream of new submission, stories "stream" through the `new` page. We suspect that the period during which a story is on the `new` page is crucial for its eventual success. The following graphic exemplifies how stories go through the `new` page. It takes about 3 hours for a story to move from rank 1 to rank 90, which is the last rank of the third page of this ranking.  

```{r new-page-stream-data}
tbl(con, "dataset") %>% 
  filter(samplingWindow == 4) %>% 
  select(id, sampleTime, newRank) %>% 
  data.frame() -> tmp

interval_duration <- 3 * 60 * 60  # 3 hours
interval_start <- min(tmp$sampleTime) + (10 * 60 * 60)
interval_end <- interval_start + interval_duration

tmp %<>% 
  filter(sampleTime > interval_start & sampleTime < interval_end) %>% 
  mutate(
    observeStory = id == 26548018,
    timePassedInInterval = sampleTime - interval_start
  )
```

```{r new-page-stream-plot}
tmp %>% 
  ggplot(aes(x = timePassedInInterval / 60, y = newRank, group = id, color = observeStory)) +
  geom_line() + 
  geom_point(size = 0.1) +
  labs(
    title = "New Page during a Window of 3 Hours",
    x = "Minutes Past",
    y = "Rank on New Page",
    caption = "Lines indicate different stories."
  ) +
  scale_y_continuous(trans = "reverse", breaks = seq(0, 90, 10)) +
  scale_color_manual(values = c("FALSE" = "darkblue", "TRUE" = "gold")) +
  theme_classic() +
  theme(
    legend.position = "None"
  )

```



## Average Time to Specific New Ranks

The following analysis is conducted on all stories for which we were able to obtain snapshots at `new` ranks 1, 30, 60, and 90. We compute the time in seconds each story took to reach these ranks to get point estimates for each average.

```{r average-time-until-new-rank}

tbl(con, "fullstories") %>%
  inner_join(tbl(con, "dataset"), by = "id") %>%
  select(id, newRank, sampleTime) %>% 
  filter(newRank %in% c(1, 30, 60, 90)) %>% 
  group_by(id, newRank) %>% 
  slice_min(sampleTime) %>% 
  ungroup() %>% 
  group_by(id) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  filter(n == 4) %>% 
  select(-n) %>% 
  data.frame() -> tmp

tmp %<>%
  pivot_wider(
    id_cols = id,
    names_from = newRank,
    values_from = sampleTime,
    names_prefix = "newRank",
    values_fn = min
  ) %>% 
  mutate(
    timePastUntil30 = newRank30 - newRank1,
    timePastUntil60 = newRank60 - newRank1,
    timePastUntil90 = newRank90 - newRank1
  ) %>% 
  select(-c(newRank1, newRank30, newRank60, newRank90)) 
  
# means and standard deviations of duration until specific ranks
meanTimePastUntil30 <- mean(tmp$timePastUntil30, na.rm = TRUE) / 60
meanTimePastUntil60 <- mean(tmp$timePastUntil60, na.rm = TRUE) / 60
meanTimePastUntil90 <- mean(tmp$timePastUntil90, na.rm = TRUE) / 60
sdTimePastUntil30 <- sd(tmp$timePastUntil30, na.rm = TRUE) / 60
sdTimePastUntil60 <- sd(tmp$timePastUntil60, na.rm = TRUE) / 60
sdTimePastUntil90 <- sd(tmp$timePastUntil90, na.rm = TRUE) / 60

```


Means:

  * time past until `new` rank 30: `r meanTimePastUntil30`
  * time past until `new` rank 60: `r meanTimePastUntil60`
  * time past until `new` rank 90: `r meanTimePastUntil90`

Standard Deviations:

  * time past until `new` rank 30: `r sdTimePastUntil30`
  * time past until `new` rank 60: `r sdTimePastUntil60`
  * time past until `new` rank 90: `r sdTimePastUntil90`



# Disconnect from Database

```{r db-disconnect}

RSQLite::dbDisconnect(conn = con)

```

